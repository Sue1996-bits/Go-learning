 **Postman**  API 测试工具来执行这些测试。

---

### **测试前的准备工作**

1.  **启动应用**:
    *   确保你的 `main.go` 是我们最终确定的、包含了所有服务和路由的版本。
    *   在终端运行 `go run main.go`。
    *   你应该能看到服务器在 `http://localhost:8080` (或你配置的端口) 成功启动的日志。

2.  **准备测试数据**:
    *   准备几张不同格式的图片（例如 `.jpg`, `.png`）用于上传。
    *   准备一个 API 测试工具。

---

### **端到端测试计划 (End-to-End Testing Plan)**

我们将模拟一个完整用户场景，并验证每个API端点。

#### **场景一：核心流程 - 上传并获取带LSB水印的图片**

**第1步：获取认证 Token (模拟登录)**

*   **请求**: `POST http://localhost:8080/api/v1/auth/token`
*   **Body**: 无
*   **预期响应 (200 OK)**:
    ```json
    {
        "access_token": "eyJhbGciOiJI...<一长串字符>" 
    }
    ```
*   **操作**: **复制**返回的 `access_token`。在后续所有需要认证的请求中，我们都将使用它。

**第2步：上传图片**

*   **请求**: `POST http://localhost:8080/api/v1/images/upload`
*   **认证 (Authorization)**: 选择 `Bearer Token`，粘贴上一步的 `access_token`。
*   **Body**: 选择 `form-data`，添加一个键值对：
    *   `key`: `image`
    *   `value`: (类型选择 `File`) 选择你本地的一张图片。
*   **预期响应 (200 OK)**:
    ```json
    {
        "success": "image uploaded and encrypted successfully",
        "id": "a-unique-uuid-string-like-this",
        "filename": "your_image_name.jpg"
    }
    ```
*   **操作**: **复制**返回的 `id` (即 `image_id`)。

**第3步：获取带 LSB 隐式水印的图片 (验证缓存和主流程)**

*   **第一次请求 (缓存未命中)**
    *   **请求**: `GET http://localhost:8080/api/v1/images/{你复制的image_id}/lsb-watermarked`
    *   **认证 (Authorization)**: 使用相同的 `access_token`。
    *   **预期行为**:
        *   在**服务器的控制台**，你应该能看到类似 `Watermarked image MISS cache for key: ...` 的日志。
        *   请求响应可能会有轻微延迟（因为它在执行解密、加水印等操作）。
    *   **预期响应 (200 OK)**: API 工具应该能显示或提示你下载返回的图片。检查图片是否完好。

*   **第二次请求 (缓存命中)**
    *   **立即**再次发送完全相同的请求。
    *   **预期行为**:
        *   在**服务器的控制台**，你应该能看到类似 `Watermarked image HIT cache for key: ...` 的日志。
        *   请求响应应该**非常快**。
    *   **预期响应 (200 OK)**: 同样返回完好的图片。

#### **场景二：明文水印功能**

**第4步：获取带明文水印的图片**

*   **请求**: `GET http://localhost:8080/api/v1/images/{同一个image_id}/visible-watermark?text=Hello World Test`
*   **认证 (Authorization)**: 使用相同的 `access_token`。
*   **预期响应 (200 OK)**: 返回的图片右下角应该带有清晰的 "Hello World Test" 文字水印。

#### **场景三：安全与权限测试**

**第5步：测试无 Token 访问**

*   **请求**: `POST http://localhost:8080/api/v1/images/upload`
*   **认证 (Authorization)**: **不提供**任何认证信息。
*   **预期响应 (401 Unauthorized)**:
    ```json
    {
        "error": "Missing authorization header",
        // ...
    }
    ```

**第6步：测试权限隔离 (可选，但非常重要)**
这个测试需要你稍微修改一下 `GenerateTestToken` 函数来模拟另一个用户。
1.  修改 `main.go` 中的 `GenerateTestToken`，将 `user_id` 改为 `"another-user-67890"`。
2.  重启服务器。
3.  用 `POST /api/v1/auth/token` 获取一个**新的** `access_token` (属于 "another-user")。
4.  现在，尝试用这个**新 token** 去访问**第一个用户**上传的图片：
    *   **请求**: `GET http://localhost:8080/api/v1/images/{第一个用户上传的image_id}/lsb-watermarked`
    *   **认证 (Authorization)**: 使用**新用户的 token**。
    *   **预期响应 (403 Forbidden)**:
        ```json
        {
            "success": false,
            "error": "permission denied: you are not the owner of this image"
        }
        ```
    *   如果得到这个响应，恭喜你，你的权限系统工作得非常完美！

#### **场景四：水印验证功能**

**第7步：验证 LSB 水印 (可选)**
这个场景比较复杂，因为它需要你先知道一个确切的水印ID。
1.  你需要暂时修改 `watermark_service.go` 的 `ProcessImage` 方法，让它打印出生成的 `watermarkID`。
2.  请求一次带 LSB 水印的图片，从服务器日志中**复制**这个 `watermarkID`。
3.  下载这张带 LSB 水印的图片到本地。
4.  发送验证请求：
    *   **请求**: `POST http://localhost:8080/api/v1/admin/verify/lsb?id={你复制的watermarkID}`
    *   **认证 (Authorization)**: 使用 `access_token`。
    *   **Body**: `form-data`，`key`: `image`，`value`: 选择你刚刚下载的那张带水印的图片。
    *   **预期响应 (200 OK)**:
        ```json
        {
            "success": true,
            "data": {
                "is_valid": true,
                "expected_id": "..."
            }
        }
        ```

---

### **测试清单总结**

- [ ] **获取Token**: `POST /auth/token` -> `200 OK`
- [ ] **上传图片**: `POST /images/upload` (带Token) -> `200 OK`
- [ ] **获取LSB水印 (缓存未命中)**: `GET /images/.../lsb-watermarked` -> `200 OK` + 控制台 `MISS` 日志
- [ ] **获取LSB水印 (缓存命中)**: (重复上一步) -> `200 OK` + 控制台 `HIT` 日志
- [ ] **获取明文水印**: `GET /images/.../visible-watermark` -> `200 OK` + 图片带文字
- [ ] **无Token访问测试**: `POST /images/upload` (无Token) -> `401 Unauthorized`
- [ ] **权限隔离测试 (可选)**: 用其他用户的Token访问图片 -> `403 Forbidden`
- [ ] **水印验证测试 (可选)**: `POST /admin/verify/lsb` -> `200 OK` + `"is_valid": true`


### **新的、更符合业务场景的测试步骤**

测试流程变得非常直观和强大：

1.  **获取 Token** (同之前)。
2.  **上传图片** (同之前)。
3.  **获取带 LSB 水印的图片**:
    *   `GET /api/v1/images/{image_id}/lsb-watermarked`
    *   **下载并保存**这张返回的图片到你的电脑，例如命名为 `watermarked_image.png`。

4.  **提取水印信息 (新测试步骤)**:
    *   **请求**: `POST http://localhost:8080/api/v1/admin/extract/lsb`
    *   **认证**: 使用有效的 `access_token`。
    *   **Body**: `form-data`，`key`: `image`，`value`: 选择你刚刚保存的 `watermarked_image.png`。
    *   **预期响应 (200 OK)**:
        ```json
        {
            "success": true,
            "data": {
                // 这个值应该是 64 个字符的十六进制字符串
                "extracted_watermark_id": "a1b2c3d4...e5f6"
            }
        }
        ```

将这个提取出的 `extracted_watermark_id` 与你数据库 `watermark_logs` 表中对应的记录进行比对，以完成整个溯源链路的验证。
