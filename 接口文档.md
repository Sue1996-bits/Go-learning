# **加密水印服务 API 技术文档**

**版本**: V1.1

**日期**: 2025.8.22

**部门**: 技术研发部

---

## **文档修订历史**

| 版本  | 日期               | 修订人 | 修订说明                                                     |
| :---- | :----------------- | :----- | :----------------------------------------------------------- |
| V1.0  | 2025.8.22   | hyf | 初始版本创建，包含认证、上传、LSB水印、可见文字水印和纯提取，以及溯源功能。            |

---

## **目录**

**1. 概述 (Overview)**
   - 1.1. 文档目的
   - 1.2. 目标读者

**2. 基础信息 (Base Information)**
   - 2.1. 基础URL
   - 2.2. API版本

**3. 认证 (Authentication)**
   - 3.1. 认证机制
   - 3.2. 认证流程

**4. 通用格式 (Common Formats)**
   - 4.1. 成功响应
   - 4.2. 失败响应

**5. API 端点详解 (API Endpoint Reference)**
   - 5.1. 认证 (Authentication)
     - 5.1.1. 获取测试 Token
   - 5.2. 图片管理 (Image Management)
     - 5.2.1. 上传并加密图片
   - 5.3. 水印处理 (Watermark Processing)
     - 5.3.1. 获取带 LSB 隐式水印的图片
     - 5.3.2. 获取带可见文字水印的图片
   - 5.4. 溯源与验证 (Tracing & Verification)
     - 5.4.1. 提取 LSB 水印信息
     - 5.4.2. 溯源图片 (数字取证)
     - 5.4.3. 验证 LSB 水印

**6. 典型工作流 (Typical Workflow)**

---

### **1. 概述 (Overview)**

#### **1.1. 文档目的**
本文档旨在为开发人员提供关于“智能水印服务 API”的详细技术规范和使用指南。它描述了所有可用的 API 端点、认证机制、请求/响应格式以及典型的工作流程，以帮助开发者快速、准确地将本服务集成到其应用程序中。

本 API 服务提供了一套完整的数字图片保护和溯源解决方案。它允许认证用户上传图片进行安全加密存储，并根据需求获取带有不可见LSB水印（用于追踪溯源）或可见文字水印的图片版本。此外，它还提供了强大的后台溯源功能，可以从图片中提取隐藏的水印信息以确定其来源。

#### **1.2. 目标读者**
本文档的目标读者为需要与本 API 服务进行交互的软件工程师、系统集成商和测试工程师。

### **2. 基础信息 (Base Information)**

#### **2.1. 基础URL**
*   **开发环境**: `http://localhost:8080`

#### **2.2. API版本**
*   当前 API 版本为 `v1`，所有端点均需添加 `/api/v1` 前缀。
*   **完整URL示例**: `http://localhost:8080/api/v1/images/upload`

### **3. 认证 (Authentication)**

#### **3.1. 认证机制**
本 API 所有核心端点均采用 **JWT (JSON Web Token)** 进行认证。客户端必须在请求的 Header 中提供一个有效的 `access_token`。

#### **3.2. 认证流程**
1.  **获取 Token**: 调用 `POST /api/v1/auth/token` 接口获取一个临时的 `access_token`。
2.  **发送 Token**: 在后续所有需要认证的请求中，添加一个 `Authorization` Header，格式为：
    ```
    Authorization: Bearer <your_access_token>
    ```

### **4. 通用格式 (Common Formats)**

#### **4.1. 成功响应**
*   对于返回 JSON 数据的成功请求，通常会有一个 `success: true` 字段和一个 `data` 对象。
*   对于返回文件数据的成功请求，响应体直接为二进制数据流，`Content-Type` 会被设置为相应的图片格式（如 `image/png`）。

#### **4.2. 失败响应**
所有失败的请求都会返回一个标准的 JSON 错误结构体。HTTP 状态码会根据错误类型而变化。（如 400, 401, 403, 404, 500）
```json
{
    "success": false,
    "error": "具体的错误信息描述"
}
```

---

### **5. API 端点详解 (API Endpoint Reference)**

---

#### **5.1. 认证 (Authentication)**

##### **5.1.1. 获取测试 Token**
`POST /api/v1/auth/token`
*   **描述**: 生成一个用于测试的、临时的 JWT access token。在生产环境中，这将被一个真正的用户登录接口取代。
*   **认证**: 无需。
*   **请求体**: 无。
*   **成功响应 (200 OK)**:
    ```json
    {
        "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAi..."
    }
    ```

---

#### **5.2. 图片管理 (Image Management)**

##### **5.2.1. 上传并加密图片**
`POST /api/v1/images/upload`
*   **描述**: 上传一张图片。服务器将对其进行 AES-CBC 加密，并将加密后的数据存入数据库。返回一个唯一的 `image_id` 用于后续操作。
*   **认证**: **需要**。
*   **请求体**: `multipart/form-data`
| 字段  | 类型 | 描述                         |
| :---- | :--- | :--------------------------- |
| `image` | File | 必须是图片文件 (如 `.jpg`, `.png`)。 |
*   **成功响应 (200 OK)**:
    ```json
    {
        "success": "image uploaded and encrypted successfully",
        "id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
        "filename": "my-photo.jpg"
    }
    ```
*   **失败响应**: `400`, `401`, `500`。
*   400 Bad Request: 未提供图片文件。
*   401 Unauthorized: 未提供或提供了无效的 Token。
*   500 Internal Server Error: 加密或数据库存储失败。

---

#### **5.3. 水印处理 (Watermark Processing)**

##### **5.3.1. 获取带 LSB 隐式水印的图片**
`GET /api/v1/images/:image_id/lsb-watermarked`
*   **描述**: 获取指定图片的带 LSB 水印版本。服务器会先解密图片，然后嵌入一个包含当前用户和时间信息的、不可见的 LSB 水印，最后将图片以**无损 PNG 格式**返回。此接口实现了缓存机制。
*   **认证**: **需要**。
*   **URL 参数**:
| 参数      | 类型   | 描述                         |
| :-------- | :----- | :--------------------------- |
| `:image_id` | string | **必需**。通过上传接口获取的图片ID。 |
*   **成功响应 (200 OK)**:
    *   **Content-Type**: `image/png`
    *   **响应体**: 图片的二进制数据流。
*   **失败响应**: `401`, `403`, `404`, `500`。
*   401 Unauthorized: 未认证。
*   403 Forbidden: 当前用户不是该图片的所有者。
*   404 Not Found: 找不到指定的 image_id。
*   500 Internal Server Error: 处理过程中发生错误。

##### **5.3.2. 获取带可见文字水印的图片**
`GET /api/v1/images/:image_id/visible-watermark`
*   **描述**: 获取指定图片的带可见文字水印的版本。服务器会解密图片，并在右下角添加指定的文字。此接口不使用缓存。
*   **认证**: **需要**。
*   **URL 参数**:
| 参数      | 类型   | 描述                         |
| :-------- | :----- | :--------------------------- |
| `:image_id` | string | **必需**。图片ID。 |
*   **Query 参数**:
| 参数 | 类型   | 描述                                     |
| :--- | :----- | :--------------------------------------- |
| `text` | string | **必需**。要添加的水印文字。建议进行URL编码。 |
*   **成功响应 (200 OK)**:
    *   **Content-Type**: 服务器会尝试保持图片的原始格式，如果失败则返回 `image/png`。
    *   **响应体**: 带有文字水印的图片的二进制数据流。
*   **失败响应**: `400`, `401`, `403`, `404`, `422`, `500`。
*   400 Bad Request: 未提供 text 查询参数。
*   401 Unauthorized, 403 Forbidden, 404 Not Found, 500 Internal Server Error。

---

#### **5.4. 溯源与验证 (Tracing & Verification)**

##### **5.4.1. 提取 LSB 水印信息**
`POST /api/v1/admin/extract/lsb`
*   **描述**: 接收一张图片，并“盲提取”其中可能包含的 LSB 水印信息。此接口仅执行技术层面的信息提取，返回的是从图片中直接恢复出的、未经校验的水印ID（十六进制字符串）。
*   **认证**: **需要** (建议配置为管理员权限)。
*   **请求体**: `multipart/form-data`
| 字段  | 类型 | 描述                 |
| :---- | :--- | :------------------- |
| `image` | File | 待提取水印的图片文件。 |
*   **成功响应 (200 OK)**:
    ```json
    {
        "success": true,
        "data": {
            "extracted_watermark_id": "93818b43..."
        }
    }
    ```
*   **失败响应**: `422`。
*   422 Unprocessable Entity: 图片文件损坏、格式不支持或尺寸太小无法提取。

##### **5.4.2. 溯源图片 (数字取证)**
`POST /api/v1/admin/trace/lsb`
*   **描述**: 接收一张疑似带 LSB 水印的图片，执行完整的“**提取 -> 纠错 -> 数据库溯源**”流程。返回完整的溯源结果。**这是推荐使用的标准溯源接口。**
*   **认证**: **需要** (建议配置为管理员权限)。
*   **请求体**: `multipart/form-data`
| 字段  | 类型 | 描述               |
| :---- | :--- | :----------------- |
| `image` | File | 待溯源的图片文件。 |
*   **成功响应 (200 OK)**:
    ```json
    {
        "success": true,
        "data": {
            "user_id": "user-12345",
            "image_id": "a1b2c3d4-...",
            "watermark_id": "93818b43...",
            "watermarked_at": "2025-08-15T10:00:00Z",
            "extraction_success": true,
            "correction_success": true
        }
    }
    ```
*   **失败响应**: `404`, `422`。

##### **5.4.3. 验证 LSB 水印**
`POST /api/v1/admin/verify/lsb`
*   **描述**: 接收一张图片和一个**预期**的水印ID，验证该图片中是否精确包含此ID。主要用于调试。
*   **认证**: **需要** (建议配置为管理员权限)。
*   **Query 参数**:
| 参数 | 类型   | 描述                               |
| :--- | :----- | :--------------------------------- |
| `id` | string | **必需**。期望找到的64位十六进制水印ID。 |
*   **请求体**: `multipart/form-data`
| 字段  | 类型 | 描述               |
| :---- | :--- | :----------------- |
| `image` | File | 待验证的图片文件。 |
*   **成功响应 (200 OK)**:
    ```json
    {
        "success": true,
        "data": {
            "is_valid": true,
            "expected_id": "93818b43..."
        }
    }
    ```
*   **失败响应**: `400`, `422`。
*   400 Bad Request: 未提供 id 查询参数。
*   422 Unprocessable Entity: 图片文件损坏或格式不支持。

---

### **6. 典型工作流 (Typical Workflow)**

1.  **用户登录**: `POST /api/v1/auth/token` -> 获得 `access_token`。
2.  **用户上传图片**: `POST /api/v1/images/upload` (携带 Token 和图片) -> 获得 `image_id`。
3.  **用户下载带追踪水印的图片**: `GET /api/v1/images/{image_id}/lsb-watermarked` (携带 Token) -> 下载图片。
4.  **(假设图片泄露) 管理员进行溯源**: `POST /api/v1/admin/trace/lsb` (携带管理员 Token 和泄露的图片) -> 获得包含 `user_id` 的溯源报告。
